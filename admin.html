<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>تمدونی — ادمین</title>
  <link href="https://cdn.jsdelivr.net/npm/vazirmatn@33.003/fonts/variable/FD.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="./src/css/styles.css">
</head>
<body class="bg-slate-950 text-slate-50 font-sans">
  <main class="max-w-3xl mx-auto px-4 py-10 space-y-6">
    <h1 class="text-xl font-bold">ادمین</h1>

    <section class="card space-y-4">
      <h2 class="section-title">دیکد کد هنرجو و تولید کد دوره</h2>

      <!-- ورودی کد هنرجو -->
      <div>
        <label class="label">کد هنرجو (از صفحه هنرجو)</label>
        <textarea id="studentCode" class="input text-xs min-h-[100px]" placeholder="کدی که هنرجو از صفحه خودش داده را اینجا Paste کنید"></textarea>
      </div>

      <!-- نمایش اطلاعات هنرجو -->
      <div id="studentInfo" class="hidden mt-4 border border-slate-700 rounded p-3 bg-slate-900 text-sm space-y-1">
        <div>نام: <span id="infoFirstName" class="font-bold"></span></div>
        <div>نام خانوادگی: <span id="infoLastName" class="font-bold"></span></div>
        <div>شماره تلفن: <span id="infoPhone" class="font-bold"></span></div>
        <div>آی‌پی: <span id="infoIP" class="font-bold"></span></div>
        <div>Student ID: <span id="infoStudentId" class="font-mono text-xs"></span></div>
      </div>

      <!-- انتخاب دوره -->
      <div>
        <label class="label">شناسه دوره</label>
        <select id="courseId" class="input">
          <option value="sgtmarket_stickercoure">دوره آموزش ساخت و طراحی استیکر</option>
        </select>
      </div>

      <!-- دکمه‌ها -->
      <div class="mt-4 flex gap-3">
        <button id="decodeBtn" class="btn-ghost">دیکد اطلاعات هنرجو</button>
        <button id="makeCode" class="btn-success">تولید کد دوره</button>
        <button id="copyCode" class="btn-ghost">کپی کد</button>
      </div>

      <!-- خروجی کد -->
      <pre id="out" class="mt-3 text-xs bg-slate-800 p-3 rounded overflow-auto"></pre>
      <p class="hint">ابتدا کد هنرجو را دیکد کنید، سپس کد دوره را بسازید.</p>
    </section>
  </main>

  <script>
    const enc = new TextEncoder();
    const toB64u = (buf) => btoa(String.fromCharCode(...new Uint8Array(buf)))
                              .replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
    const fromB64u = (str) => {
      str = str.replace(/-/g,'+').replace(/_/g,'/');
      const pad = str.length % 4 ? '='.repeat(4 - (str.length % 4)) : '';
      return Uint8Array.from(atob(str + pad), c => c.charCodeAt(0));
    };

    let decodedData = null;

    // دیکد کد هنرجو
    document.getElementById('decodeBtn').onclick = () => {
      const code = document.getElementById('studentCode').value.trim();
      if (!code) return alert('کد هنرجو را وارد کنید.');
      try {
        const bytes = fromB64u(code);
        const json = JSON.parse(new TextDecoder().decode(bytes));
        decodedData = json;
        // پر کردن فیلدها
        document.getElementById('infoFirstName').textContent = json.firstName || '-';
        document.getElementById('infoLastName').textContent = json.lastName || '-';
        document.getElementById('infoPhone').textContent = json.phone || '-';
        document.getElementById('infoIP').textContent = json.ip || '-';
        document.getElementById('infoStudentId').textContent = json.studentId || '-';
        document.getElementById('studentInfo').classList.remove('hidden');
      } catch (e) {
        console.error(e);
        alert('کد نامعتبر است یا فرمت JSON ندارد.');
      }
    };

    // ساخت کد دوره
    document.getElementById('makeCode').onclick = () => {
      if (!decodedData) return alert('ابتدا کد هنرجو را دیکد کنید.');
      const courseId = document.getElementById('courseId').value;
      const payload = {
        v: 1,
        studentId: decodedData.studentId,
        courseId,
        ts: Date.now(),
        nonce: crypto.getRandomValues(new Uint32Array(1))[0]
      };
      const json = JSON.stringify(payload);
      const code = toB64u(enc.encode(json));
      document.getElementById('out').textContent = code;
    };

    // کپی کد
        document.getElementById('copyCode').onclick = async () => {
      const t = document.getElementById('out').textContent.trim();
      if (!t) {
        alert('کدی برای کپی وجود ندارد.');
        return;
      }
      try {
        await navigator.clipboard.writeText(t);
        alert('کد در کلیپ‌بورد کپی شد.');
      } catch (err) {
        console.error(err);
        alert('خطا در کپی کردن کد.');
      }
    };
  </script>
</body>
</html>